#!/bin/bash

# ========== PORT RELAY INSTALL ==========
#
# 1. Checks system requirements
# 2. Installs dependencies (socat, etc)
# 3. Configures kernel parameters (sysctl)
# 4. Creates systemd service port-relay
# 5. Starts the relay
#

set -e

# ========== LOAD CONFIGURATION ==========
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/relay-config"

echo
echo "========================================"
echo "Port Relay Install"
echo "========================================"
echo

load_env || { echo "Error: .env file not found! Please create .env file first"; exit 1; }
parse_relay_entries
if [[ ${#RELAY_ENTRIES[@]} -eq 0 ]]; then
	echo "Error: No valid RELAY_* entries found in .env (format: incoming_port,outgoing_port,outgoing_host)"
	exit 1
fi
check_duplicate_ports || exit 1

echo "Configuration loaded from: $SCRIPT_DIR/.env"
echo "Relay mappings: ${#RELAY_ENTRIES[@]}"
echo

# ========== SYSTEM INFORMATION (FOR ANALYSIS) ==========
echo "========================================"
echo "System information"
echo "========================================"
echo "OS: $(lsb_release -si) $(lsb_release -sr) ($(lsb_release -sc))"
echo "Kernel: $(uname -r)"
echo "Arch: $(uname -m)"
echo "Hostname: $(hostname)"
echo "Uptime: $(uptime -p 2>/dev/null || cat /proc/uptime | awk '{printf "%dd %dh %dm", $1/86400, ($1%86400)/3600, ($1%3600)/60}')"
DEFAULT_INTERFACE_PRE="$(ip route get 1.2.3.4 2>/dev/null | awk '{print $5; exit}')"
DEFAULT_IP_PRE="$(ip route get 1.2.3.4 2>/dev/null | awk '{print $7; exit}')"
echo "Default route interface: ${DEFAULT_INTERFACE_PRE:-n/a}"
echo "Default route IP: ${DEFAULT_IP_PRE:-n/a}"
if lsmod 2>/dev/null | grep -q '^nf_conntrack'; then
	echo "nf_conntrack: loaded"
else
	echo "nf_conntrack: not loaded"
fi
if [[ -f /proc/sys/net/netfilter/nf_conntrack_max ]]; then
	echo "nf_conntrack_max (current): $(cat /proc/sys/net/netfilter/nf_conntrack_max)"
else
	echo "nf_conntrack_max: not available (module not loaded or not present)"
fi
echo "========================================"
echo

# ========== SYSTEM CHECKS ==========
echo "Checking system requirements..."

if [[ -f /var/run/reboot-required ]] || pidof apt apt-get dpkg unattended-upgrades >/dev/null 2>&1; then
	echo "Error: System requires reboot or package manager is running"
	exit 2
fi

if [[ "$EUID" -ne 0 ]]; then
	echo "Error: This script requires root privileges"
	exit 3
fi

OS="$(lsb_release -si | tr '[:upper:]' '[:lower:]')"
VERSION="$(lsb_release -rs | cut -d '.' -f1)"

if [[ "$OS" == "debian" ]]; then
	[[ "$VERSION" == "11" || "$VERSION" == "12" ]] || { echo "Error: Debian 11 or 12 required"; exit 5; }
elif [[ "$OS" == "ubuntu" ]]; then
	[[ "$VERSION" == "22" || "$VERSION" == "24" ]] || { echo "Error: Ubuntu 22 or 24 required"; exit 6; }
else
	echo "Error: Unsupported OS: $OS"
	exit 7
fi

echo "✓ System check passed"
echo

# ========== NETWORK INFO ==========
DEFAULT_INTERFACE="$(ip route get 1.2.3.4 2>/dev/null | awk '{print $5; exit}')"
DEFAULT_IP="$(ip route get 1.2.3.4 2>/dev/null | awk '{print $7; exit}')"

[[ -n "$DEFAULT_INTERFACE" ]] || { echo "Error: Network interface not found"; exit 8; }
[[ -n "$DEFAULT_IP" ]] || { echo "Error: IP address not found"; exit 9; }

echo "Network: $DEFAULT_INTERFACE ($DEFAULT_IP)"
echo

# ========== INSTALL DEPENDENCIES ==========
echo "Installing dependencies..."

export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get install -y socat netcat-openbsd iptables iptables-persistent

echo "✓ Dependencies installed"
echo

# ========== SYSCTL OPTIMIZATION ==========
echo "Configuring kernel parameters for port relay..."

cat > /etc/sysctl.d/99-port-relay.conf <<'EOF'
# ========== PORT RELAY OPTIMIZATION ==========
net.ipv4.ip_forward=1

# ========== TCP TUNING FOR HIGH LATENCY ==========
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr

# ========== BUFFERS FOR LOW-BANDWIDTH NETWORKS ==========
net.core.rmem_max=16777216
net.core.wmem_max=16777216
net.ipv4.tcp_rmem=16384 262144 16777216
net.ipv4.tcp_wmem=16384 262144 16777216

# ========== KEEP-ALIVE (CRITICAL FOR UNRELIABLE NETWORKS) ==========
net.ipv4.tcp_keepalive_time=45
net.ipv4.tcp_keepalive_intvl=10
net.ipv4.tcp_keepalive_probes=3

# ========== CONNECTION HANDLING ==========
net.netfilter.nf_conntrack_max=131072
net.core.somaxconn=4096
net.ipv4.tcp_max_syn_backlog=4096

# ========== RELIABILITY ==========
net.ipv4.tcp_sack=1
net.ipv4.tcp_dsack=1
net.ipv4.tcp_timestamps=1
net.ipv4.tcp_window_scaling=1

# ========== OTHER ==========
net.ipv4.tcp_mtu_probing=1
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
EOF

echo "Loading nf_conntrack module (required for nf_conntrack_max)..."
if modprobe nf_conntrack 2>&1; then
	echo "modprobe nf_conntrack: OK"
else
	echo "modprobe nf_conntrack: FAILED or not available (nf_conntrack_max will not apply)"
fi

echo "Applying sysctl from /etc/sysctl.d/99-port-relay.conf ..."
set +e
sysctl -p /etc/sysctl.d/99-port-relay.conf
SYSCTL_EXIT=$?
set -e
if [[ $SYSCTL_EXIT -ne 0 ]]; then
	echo "Warning: sysctl reported errors (exit $SYSCTL_EXIT). Check lines above for missing or read-only parameters."
fi

echo "Current key parameters (for verification):"
for k in net.ipv4.ip_forward net.core.default_qdisc net.ipv4.tcp_congestion_control \
	net.ipv4.tcp_keepalive_time net.ipv4.tcp_keepalive_intvl net.ipv4.tcp_keepalive_probes \
	net.core.somaxconn net.ipv4.tcp_max_syn_backlog; do
	v=$(sysctl -n "$k" 2>/dev/null) && echo "  $k = $v" || echo "  $k = (not available)"
done
if [[ -f /proc/sys/net/netfilter/nf_conntrack_max ]]; then
	echo "  net.netfilter.nf_conntrack_max = $(cat /proc/sys/net/netfilter/nf_conntrack_max)"
else
	echo "  net.netfilter.nf_conntrack_max = (not available)"
fi

echo "✓ Kernel parameters configured"
echo

# ========== CREATE LOGS DIRECTORY ==========
echo "Creating logs directory..."

mkdir -p "$SCRIPT_DIR/logs"
chmod 755 "$SCRIPT_DIR/logs"

echo "✓ Logs directory: $SCRIPT_DIR/logs"
echo

# ========== MAKE SCRIPTS EXECUTABLE ==========
echo "Setting up relay scripts..."

chmod +x "$SCRIPT_DIR/relay"
chmod +x "$SCRIPT_DIR/monitor"
chmod +x "$SCRIPT_DIR/uninstall" 2>/dev/null || true

echo "✓ Scripts are executable"
echo

# ========== CREATE SYSTEMD SERVICE ==========
echo "Creating systemd service ($RELAY_SERVICE_NAME)..."

cat > "/etc/systemd/system/${RELAY_SERVICE_NAME}.service" <<SERVICE_FILE
[Unit]
Description=Port Relay (TCP forwarding)
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=$SCRIPT_DIR

ExecStart=$SCRIPT_DIR/relay

Restart=always
RestartSec=5
StartLimitIntervalSec=120
StartLimitBurst=5

StandardOutput=journal
StandardError=journal
SyslogIdentifier=$RELAY_SERVICE_NAME

[Install]
WantedBy=multi-user.target
SERVICE_FILE

systemctl daemon-reload
systemctl enable "$RELAY_SERVICE_NAME"

echo "✓ Systemd service created: $RELAY_SERVICE_NAME"
echo

# ========== CONFIGURE FIREWALL ==========
echo "Configuring firewall rules..."

relay_firewall_apply

echo "✓ Firewall rules configured"
echo

# ========== START SERVICE ==========
echo "Starting relay service..."

systemctl start "$RELAY_SERVICE_NAME"

sleep 2

if systemctl is-active "$RELAY_SERVICE_NAME" > /dev/null 2>&1; then
	echo "✓ Service is RUNNING"
else
	echo "⚠ Service failed to start"
	systemctl status "$RELAY_SERVICE_NAME"
	exit 1
fi

echo

# ========== FINAL OUTPUT ==========
echo "========================================"
echo "✓ Install Complete!"
echo "========================================"
echo
echo "Service Information:"
echo "  Name: $RELAY_SERVICE_NAME"
echo "  Status: RUNNING"
echo "  Auto-start: ENABLED"
echo
echo "Configuration:"
echo "  Config: $SCRIPT_DIR/.env"
echo "  Logs: $SCRIPT_DIR/logs/relay.log"
echo
echo "Relays (in_port → out_host:out_port):"
idx=1
for entry in "${RELAY_ENTRIES[@]}"; do
	IFS=':' read -r in_port out_port out_host <<< "$entry"
	echo "  $idx: $DEFAULT_IP:$in_port → $out_host:$out_port"
	((idx++))
done
echo "  Connect to $DEFAULT_IP:<in_port> for each relay."
echo
echo "Useful Commands:"
echo "  systemctl status $RELAY_SERVICE_NAME"
echo "  systemctl start $RELAY_SERVICE_NAME"
echo "  systemctl stop $RELAY_SERVICE_NAME"
echo "  systemctl restart $RELAY_SERVICE_NAME"
echo "  tail -f $SCRIPT_DIR/logs/relay.log"
echo "  $SCRIPT_DIR/monitor"
echo
echo "========================================"
