#!/bin/bash
RELAY_PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
RELAY_SERVICE_NAME="${RELAY_SERVICE_NAME:-port-relay}"

load_env() {
	if [[ ! -f "$RELAY_PROJECT_DIR/.env" ]]; then
		echo "Error: .env file not found in $RELAY_PROJECT_DIR"
		return 1
	fi
	source "$RELAY_PROJECT_DIR/.env"
	return 0
}

parse_relay_entries() {
	RELAY_ENTRIES=()
	for key in $(printf '%s\n' "${!RELAY_@}" | grep -E '^RELAY_[0-9]+$' | sort -V); do
		value="${!key}"
		IFS=',' read -r in_port out_port out_host <<< "$value"
		if [[ -n "$in_port" && -n "$out_port" && -n "$out_host" ]]; then
			RELAY_ENTRIES+=("$in_port:$out_port:$out_host")
		fi
	done
}

check_duplicate_ports() {
	local seen=""
	for entry in "${RELAY_ENTRIES[@]}"; do
		local in_port="${entry%%:*}"
		if [[ "$seen" == *" $in_port "* ]]; then
			echo "Error: Duplicate incoming port $in_port in RELAY_* entries (only one listener per port)"
			return 1
		fi
		seen="$seen $in_port "
	done
	return 0
}

check_target() {
	local host="$1"
	local port="$2"
	local timeout="${3:-5}"
	local retries="${4:-3}"
	local attempt=1
	local run_timeout=""
	if command -v timeout >/dev/null 2>&1; then
		run_timeout() { timeout "$@"; }
	else
		run_timeout() { shift; "$@"; }
	fi
	while [[ $attempt -le $retries ]]; do
		if run_timeout "$timeout" /bin/bash -c "echo -n '' > /dev/tcp/$host/$port" 2>/dev/null; then
			return 0
		fi
		if command -v nc >/dev/null 2>&1; then
			if run_timeout "$((timeout + 2))" nc -4 -z -w "$timeout" "$host" "$port" 2>/dev/null; then
				return 0
			fi
		fi
		((attempt++)) || true
	done
	return 1
}

relay_service_stop() {
	systemctl stop "$RELAY_SERVICE_NAME" 2>/dev/null || true
}

relay_service_disable() {
	systemctl disable "$RELAY_SERVICE_NAME" 2>/dev/null || true
}

relay_firewall_remove() {
	for entry in "${RELAY_ENTRIES[@]}"; do
		in_port="${entry%%:*}"
		iptables -D INPUT -p tcp --dport "$in_port" -j ACCEPT 2>/dev/null || true
	done
	netfilter-persistent save 2>/dev/null || true
}

relay_firewall_apply() {
	for entry in "${RELAY_ENTRIES[@]}"; do
		in_port="${entry%%:*}"
		iptables -D INPUT -p tcp --dport "$in_port" -j ACCEPT 2>/dev/null || true
		iptables -A INPUT -p tcp --dport "$in_port" -j ACCEPT 2>/dev/null || true
	done
	netfilter-persistent save 2>/dev/null || true
}
