#!/bin/bash

# ========== PORT RELAY MONITOR ==========
# Displays real-time status of the relay

set -e

# ========== LOAD CONFIGURATION ==========
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/relay-config"

load_env || exit 1
parse_relay_entries

LOG_FILE="$SCRIPT_DIR/logs/relay.log"

# ========== MONITOR LOOP ==========
while true; do
	clear
	echo "========================================"
	echo "Port Relay Monitor"
	echo "========================================"
	echo
	
	echo "Configuration:"
	echo "  Project: $SCRIPT_DIR"
	echo
	
	echo "Outbound Connectivity:"
	for entry in "${RELAY_ENTRIES[@]}"; do
		IFS=':' read -r in_port out_port out_host <<< "$entry"
		echo -n "  ✓ $out_host:$out_port: "
		check_target "$out_host" "$out_port" 2 && echo "UP" || echo "DOWN"
	done
	echo
	
	echo "Relay Service Status:"
	echo -n "  Service: "
	if systemctl is-active port-relay > /dev/null 2>&1; then
		echo "✓ RUNNING"
	else
		echo "✗ STOPPED"
	fi
	echo
	
	echo "Connections per relay:"
	for entry in "${RELAY_ENTRIES[@]}"; do
		in_port="${entry%%:*}"
		count=$(ss -tn 2>/dev/null | grep ":$in_port " | wc -l)
		echo -n "  Port $in_port: $count connection(s)"
		echo
	done
	
	echo "Recent Logs:"
	if [[ -f "$LOG_FILE" ]]; then
		tail -5 "$LOG_FILE"
	else
		echo "  (No logs yet - relay not started)"
	fi
	echo
	
	echo "========================================"
	echo "Updated every 5 seconds (Ctrl+C to exit)"
	echo "========================================"
	
	sleep 5
done
