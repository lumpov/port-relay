#!/bin/bash

# ========== PORT RELAY ==========
#
# TCP relay: входящий порт → исходящий хост:порт
#
# Клиент подключается к relay_server:53333
# relay принимает через socat и пересылает на заданный хост:порт
# Трафик 1:1 без изменений
#

set -e

# ========== LOAD CONFIGURATION ==========
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/relay-config"

load_env || exit 1
parse_relay_entries
if [[ ${#RELAY_ENTRIES[@]} -eq 0 ]]; then
	echo "Error: No valid RELAY_* entries found in .env (format: incoming_port,outgoing_port,outgoing_host)"
	exit 1
fi
check_duplicate_ports || exit 1

# ========== CREATE LOGS DIRECTORY ==========
mkdir -p "$SCRIPT_DIR/logs"
LOG_FILE="$SCRIPT_DIR/logs/relay.log"

CONNECT_TIMEOUT="${CONNECT_TIMEOUT:-15}"
KEEPALIVE_IDLE="${KEEPALIVE_IDLE:-30}"
KEEPALIVE_INTVL="${KEEPALIVE_INTVL:-10}"
KEEPALIVE_CNT="${KEEPALIVE_CNT:-3}"

# ========== LOGGING FUNCTION ==========
log_msg() {
	local msg="[$(date +'%Y-%m-%d %H:%M:%S')] $1"
	
	if [[ "$ENABLE_LOGGING" == "y" ]]; then
		echo "$msg" | tee -a "$LOG_FILE"
	else
		echo "$msg"
	fi
}

# ========== START LOGGING ==========
log_msg "========================================="
log_msg "Port Relay Started"
log_msg "========================================="
log_msg "Port mapping:"
for entry in "${RELAY_ENTRIES[@]}"; do
	IFS=':' read -r in_port out_port out_host <<< "$entry"
	log_msg "  Local :$in_port → $out_host:$out_port"
done
log_msg "Logging: $ENABLE_LOGGING"
log_msg "Health Checks: $ENABLE_HEALTH_CHECK"

# ========== INITIAL HEALTH CHECK ==========
if [[ "$ENABLE_HEALTH_CHECK" == "y" ]]; then
	log_msg "Performing initial health check..."
	for entry in "${RELAY_ENTRIES[@]}"; do
		IFS=':' read -r in_port out_port out_host <<< "$entry"
		if check_target "$out_host" "$out_port" "${HEALTH_CHECK_TIMEOUT:-10}" "${HEALTH_CHECK_RETRIES:-3}"; then
			log_msg "✓ $out_host:$out_port - REACHABLE"
		else
			log_msg "⚠ $out_host:$out_port - UNREACHABLE (warning)"
		fi
	done
fi

# ========== START RELAY INSTANCES ==========
log_msg "Starting relay instances..."

RELAY_PIDS=()
for entry in "${RELAY_ENTRIES[@]}"; do
	IFS=':' read -r in_port out_port out_host <<< "$entry"
	log_msg "Starting: :$in_port → $out_host:$out_port"
	socat \
		TCP4-LISTEN:$in_port,reuseaddr,fork,bind=0.0.0.0,keepalive,keepidle=$KEEPALIVE_IDLE,keepintvl=$KEEPALIVE_INTVL,keepcnt=$KEEPALIVE_CNT \
		TCP4:$out_host:$out_port,connect-timeout=$CONNECT_TIMEOUT,keepalive,keepidle=$KEEPALIVE_IDLE,keepintvl=$KEEPALIVE_INTVL,keepcnt=$KEEPALIVE_CNT \
		&
	RELAY_PIDS+=($!)
	log_msg "Relay started (PID: ${RELAY_PIDS[-1]})"
done

log_msg "All relay instances started!"
log_msg "Relay ready for connections..."
log_msg "========================================="

cleanup() {
	local code="${1:-0}"
	log_msg "Shutting down relay..."
	for pid in "${RELAY_PIDS[@]}"; do
		kill -TERM "$pid" 2>/dev/null || true
	done
	wait "${RELAY_PIDS[@]}" 2>/dev/null || true
	exit "$code"
}
trap 'cleanup 0' SIGTERM SIGINT

if [[ "$ENABLE_HEALTH_CHECK" == "y" ]]; then
	while true; do
		for pid in "${RELAY_PIDS[@]}"; do
			if ! kill -0 "$pid" 2>/dev/null; then
				log_msg "Relay process $pid died, exiting for systemd restart"
				cleanup 1
			fi
		done
		sleep 60
		source "$SCRIPT_DIR/lib/relay-config"
		export PATH="${PATH:-/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin}"
		for entry in "${RELAY_ENTRIES[@]}"; do
			IFS=':' read -r in_port out_port out_host <<< "$entry"
			if check_target "$out_host" "$out_port" "${HEALTH_CHECK_TIMEOUT:-10}" "${HEALTH_CHECK_RETRIES:-3}"; then
				log_msg "✓ $out_host:$out_port is UP"
			else
				log_msg "⚠ WARNING: $out_host:$out_port is DOWN!"
			fi
		done
	done
else
	wait "${RELAY_PIDS[@]}"
fi
