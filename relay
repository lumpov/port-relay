#!/bin/bash

# ========== MINING POOL RELAY ==========
# 
# TCP relay application for mining pools
# 
# What it does:
#   Miner connects to: proxy_server:53333
#   ↓
#   relay receives via socat
#   ↓
#   relay forwards to: btc.trustpool.cc:3333
#   ↓
#   All traffic relayed 1:1 (100% transparent, no changes)
#

set -e

# ========== LOAD CONFIGURATION ==========
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ ! -f "$SCRIPT_DIR/.env" ]]; then
	echo "Error: .env file not found in $SCRIPT_DIR"
	exit 1
fi

source "$SCRIPT_DIR/.env"

# ========== CREATE LOGS DIRECTORY ==========
mkdir -p "$SCRIPT_DIR/logs"
LOG_FILE="$SCRIPT_DIR/logs/relay.log"

# ========== LOGGING FUNCTION ==========
log_msg() {
	local msg="[$(date +'%Y-%m-%d %H:%M:%S')] $1"
	
	if [[ "$ENABLE_LOGGING" == "y" ]]; then
		echo "$msg" | tee -a "$LOG_FILE"
	else
		echo "$msg"
	fi
}

# ========== HEALTH CHECK FUNCTION ==========
check_pool() {
	local host="$1"
	local port="$2"
	
	if timeout 5 bash -c "echo -n '' > /dev/tcp/$host/$port" 2>/dev/null; then
		return 0
	else
		return 1
	fi
}

# ========== START LOGGING ==========
log_msg "========================================="
log_msg "Mining Pool Relay Started"
log_msg "========================================="
log_msg "Pool: $POOL_HOST"
log_msg "Port mapping:"
log_msg "  Local :$PROXY_PORT_1 → $POOL_HOST:$POOL_PORT_1"
log_msg "  Local :$PROXY_PORT_2 → $POOL_HOST:$POOL_PORT_2"
log_msg "  Local :$PROXY_PORT_3 → $POOL_HOST:$POOL_PORT_3"
log_msg "Logging: $ENABLE_LOGGING"
log_msg "Health Checks: $ENABLE_HEALTH_CHECK"

# ========== INITIAL HEALTH CHECK ==========
if [[ "$ENABLE_HEALTH_CHECK" == "y" ]]; then
	log_msg "Performing initial health check..."
	
	for port in $POOL_PORT_1 $POOL_PORT_2 $POOL_PORT_3; do
		if check_pool "$POOL_HOST" "$port"; then
			log_msg "✓ Pool $POOL_HOST:$port - REACHABLE"
		else
			log_msg "⚠ Pool $POOL_HOST:$port - UNREACHABLE (warning)"
		fi
	done
fi

# ========== START RELAY INSTANCES ==========
log_msg "Starting relay instances..."

# Relay instance 1: Port mapping 1
log_msg "Starting: :$PROXY_PORT_1 → $POOL_HOST:$POOL_PORT_1"
socat \
	TCP4-LISTEN:$PROXY_PORT_1,reuseaddr,fork,bind=0.0.0.0 \
	TCP4:$POOL_HOST:$POOL_PORT_1 &
RELAY_1_PID=$!
log_msg "Relay instance 1 started (PID: $RELAY_1_PID)"

# Relay instance 2: Port mapping 2
log_msg "Starting: :$PROXY_PORT_2 → $POOL_HOST:$POOL_PORT_2"
socat \
	TCP4-LISTEN:$PROXY_PORT_2,reuseaddr,fork,bind=0.0.0.0 \
	TCP4:$POOL_HOST:$POOL_PORT_2 &
RELAY_2_PID=$!
log_msg "Relay instance 2 started (PID: $RELAY_2_PID)"

# Relay instance 3: Port mapping 3
log_msg "Starting: :$PROXY_PORT_3 → $POOL_HOST:$POOL_PORT_3"
socat \
	TCP4-LISTEN:$PROXY_PORT_3,reuseaddr,fork,bind=0.0.0.0 \
	TCP4:$POOL_HOST:$POOL_PORT_3 &
RELAY_3_PID=$!
log_msg "Relay instance 3 started (PID: $RELAY_3_PID)"

log_msg "All relay instances started!"
log_msg "Relay ready for miner connections..."
log_msg "========================================="

# ========== HEALTH CHECK LOOP ==========
if [[ "$ENABLE_HEALTH_CHECK" == "y" ]]; then
	while true; do
		sleep 60
		
		for port in $POOL_PORT_1 $POOL_PORT_2 $POOL_PORT_3; do
			if ! check_pool "$POOL_HOST" "$port"; then
				log_msg "⚠ WARNING: Pool $POOL_HOST:$port is DOWN!"
			fi
		done
	done
else
	# Keep running and wait for relay processes
	wait $RELAY_1_PID $RELAY_2_PID $RELAY_3_PID
fi