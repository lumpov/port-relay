#!/bin/bash

# ========== MINING POOL RELAY SETUP ==========
# 
# Installation script that:
# 1. Checks system requirements
# 2. Installs dependencies (socat, etc)
# 3. Configures kernel parameters (sysctl)
# 4. Creates systemd service
# 5. Starts the relay
#
# The actual relay binary handles TCP forwarding
#

set -e

# ========== LOAD CONFIGURATION ==========
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo
echo "========================================"
echo "Mining Pool Relay Setup"
echo "========================================"
echo

if [[ ! -f "$SCRIPT_DIR/.env" ]]; then
	echo "Error: .env file not found!"
	echo "Please create .env file first"
	exit 1
fi

source "$SCRIPT_DIR/.env"

echo "Configuration loaded from: $SCRIPT_DIR/.env"
echo "Pool: $POOL_HOST"
echo "Relay Ports: $PROXY_PORT_1, $PROXY_PORT_2, $PROXY_PORT_3"
echo

# ========== SYSTEM CHECKS ==========
echo "Checking system requirements..."

if [[ -f /var/run/reboot-required ]] || pidof apt apt-get dpkg unattended-upgrades >/dev/null 2>&1; then
	echo "Error: System requires reboot or package manager is running"
	exit 2
fi

if [[ "$EUID" -ne 0 ]]; then
	echo "Error: This script requires root privileges"
	exit 3
fi

OS="$(lsb_release -si | tr '[:upper:]' '[:lower:]')"
VERSION="$(lsb_release -rs | cut -d '.' -f1)"

if [[ "$OS" == "debian" ]]; then
	[[ "$VERSION" == "11" || "$VERSION" == "12" ]] || { echo "Error: Debian 11 or 12 required"; exit 5; }
elif [[ "$OS" == "ubuntu" ]]; then
	[[ "$VERSION" == "22" || "$VERSION" == "24" ]] || { echo "Error: Ubuntu 22 or 24 required"; exit 6; }
else
	echo "Error: Unsupported OS: $OS"
	exit 7
fi

echo "✓ System check passed"
echo

# ========== NETWORK INFO ==========
DEFAULT_INTERFACE="$(ip route get 1.2.3.4 2>/dev/null | awk '{print $5; exit}')"
DEFAULT_IP="$(ip route get 1.2.3.4 2>/dev/null | awk '{print $7; exit}')"

[[ -n "$DEFAULT_INTERFACE" ]] || { echo "Error: Network interface not found"; exit 8; }
[[ -n "$DEFAULT_IP" ]] || { echo "Error: IP address not found"; exit 9; }

echo "Network: $DEFAULT_INTERFACE ($DEFAULT_IP)"
echo

# ========== INSTALL DEPENDENCIES ==========
echo "Installing dependencies..."

export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get install -y socat netcat-openbsd iptables iptables-persistent

echo "✓ Dependencies installed"
echo

# ========== SYSCTL OPTIMIZATION ==========
echo "Configuring kernel parameters for mining relay..."

cat > /etc/sysctl.d/99-mining-relay.conf <<'EOF'
# ========== MINING RELAY OPTIMIZATION ==========
net.ipv4.ip_forward=1

# ========== TCP TUNING FOR HIGH LATENCY ==========
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr

# ========== BUFFERS FOR LOW-BANDWIDTH NETWORKS ==========
net.core.rmem_max=16777216
net.core.wmem_max=16777216
net.ipv4.tcp_rmem=16384 262144 16777216
net.ipv4.tcp_wmem=16384 262144 16777216

# ========== KEEP-ALIVE (CRITICAL FOR UNRELIABLE NETWORKS) ==========
net.ipv4.tcp_keepalives_time=45
net.ipv4.tcp_keepalives_intvl=10
net.ipv4.tcp_keepalives_probes=3

# ========== CONNECTION HANDLING ==========
net.netfilter.nf_conntrack_max=131072
net.core.somaxconn=4096
net.ipv4.tcp_max_syn_backlog=4096

# ========== RELIABILITY ==========
net.ipv4.tcp_sack=1
net.ipv4.tcp_dsack=1
net.ipv4.tcp_fack=1
net.ipv4.tcp_timestamps=1
net.ipv4.tcp_window_scaling=1

# ========== OTHER ==========
net.ipv4.tcp_mtu_probing=1
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
EOF

sysctl -p /etc/sysctl.d/99-mining-relay.conf > /dev/null

echo "✓ Kernel parameters configured"
echo

# ========== CREATE LOGS DIRECTORY ==========
echo "Creating logs directory..."

mkdir -p "$SCRIPT_DIR/logs"
chmod 755 "$SCRIPT_DIR/logs"

echo "✓ Logs directory: $SCRIPT_DIR/logs"
echo

# ========== MAKE SCRIPTS EXECUTABLE ==========
echo "Setting up relay scripts..."

chmod +x "$SCRIPT_DIR/relay"
chmod +x "$SCRIPT_DIR/monitor"

echo "✓ Scripts are executable"
echo

# ========== CREATE SYSTEMD SERVICE ==========
echo "Creating systemd service (mining-relay)..."

cat > /etc/systemd/system/mining-relay.service <<SERVICE_FILE
[Unit]
Description=Mining Pool Relay (TCP forwarding)
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=$SCRIPT_DIR

# Run relay from project directory (loads .env automatically)
ExecStart=$SCRIPT_DIR/relay

# Restart if it crashes
Restart=always
RestartSec=5

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=mining-relay

[Install]
WantedBy=multi-user.target
SERVICE_FILE

systemctl daemon-reload

echo "✓ Systemd service created: mining-relay"
echo

# ========== CONFIGURE FIREWALL ==========
echo "Configuring firewall rules..."

for PORT in $PROXY_PORT_1 $PROXY_PORT_2 $PROXY_PORT_3; do
	iptables -A INPUT -p tcp --dport $PORT -j ACCEPT 2>/dev/null || true
done

netfilter-persistent save 2>/dev/null || true

echo "✓ Firewall rules configured"
echo

# ========== START SERVICE ==========
echo "Starting relay service..."

systemctl start mining-relay

sleep 2

if systemctl is-active mining-relay > /dev/null 2>&1; then
	echo "✓ Service is RUNNING"
else
	echo "⚠ Service failed to start"
	systemctl status mining-relay
	exit 1
fi

echo

# ========== FINAL OUTPUT ==========
echo "========================================"
echo "✓ Setup Complete!"
echo "========================================"
echo
echo "Service Information:"
echo "  Name: mining-relay"
echo "  Status: RUNNING"
echo "  Auto-start: ENABLED"
echo
echo "Configuration:"
echo "  Config: $SCRIPT_DIR/.env"
echo "  Logs: $SCRIPT_DIR/logs/relay.log"
echo
echo "Relay Ports:"
echo "  Miner 1: $DEFAULT_IP:$PROXY_PORT_1 → $POOL_HOST:$POOL_PORT_1"
echo "  Miner 2: $DEFAULT_IP:$PROXY_PORT_2 → $POOL_HOST:$POOL_PORT_2"
echo "  Miner 3: $DEFAULT_IP:$PROXY_PORT_3 → $POOL_HOST:$POOL_PORT_3"
echo
echo "Miner Configuration:"
echo "  Pool 1 URL: $DEFAULT_IP:$PROXY_PORT_1"
echo "  Pool 1 Worker: user1"
echo "  Pool 1 Password: x"
echo
echo "  (Use user2, user3 for additional miners)"
echo
echo "Useful Commands:"
echo "  systemctl status mining-relay"
echo "  systemctl start mining-relay"
echo "  systemctl stop mining-relay"
echo "  systemctl restart mining-relay"
echo "  tail -f $SCRIPT_DIR/logs/relay.log"
echo "  $SCRIPT_DIR/monitor"
echo
echo "========================================"