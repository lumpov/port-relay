#!/bin/bash

# ========== PORT RELAY UNINSTALL ==========
# Stops service, removes systemd unit and sysctl config

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/relay-config"

if [[ "$EUID" -ne 0 ]]; then
	echo "Error: This script requires root privileges"
	exit 1
fi

load_env 2>/dev/null && parse_relay_entries || RELAY_ENTRIES=()

echo "Stopping $RELAY_SERVICE_NAME..."
relay_service_stop

echo "Disabling $RELAY_SERVICE_NAME..."
relay_service_disable

if [[ -f /etc/systemd/system/${RELAY_SERVICE_NAME}.service ]]; then
	echo "Removing systemd service..."
	rm -f "/etc/systemd/system/${RELAY_SERVICE_NAME}.service"
	systemctl daemon-reload
	echo "✓ Service removed"
fi

if [[ -f /etc/sysctl.d/99-port-relay.conf ]]; then
	echo "Removing sysctl config..."
	rm -f /etc/sysctl.d/99-port-relay.conf
	sysctl -p 2>/dev/null || true
	echo "✓ Sysctl config removed"
fi

if [[ ${#RELAY_ENTRIES[@]} -gt 0 ]]; then
	echo "Removing UDP NAT rules..."
	relay_udp_nat_remove
	echo "Removing conntrack rules..."
	relay_conntrack_remove
	echo "Removing firewall rules..."
	relay_firewall_remove
	netfilter-persistent save 2>/dev/null || true
	echo "✓ Firewall and NAT rules removed"
fi

echo
echo "✓ Uninstall complete. Project files in $SCRIPT_DIR left intact."
